#!/bin/bash

# Kubernetes —Ñ—É–Ω–∫—Ü–∏–∏

check_kubectl() {
  if ! command -v kubectl &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: kubectl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
  fi
}

cluster_status() {
  local environment=$1
  
  check_kubectl
  
  echo "üìä –°—Ç–∞—Ç—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes:"
  echo ""
  
  echo "üè∑Ô∏è  Cluster Info:"
  kubectl cluster-info 2>/dev/null || echo "  –ö–ª–∞—Å—Ç–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
  echo ""
  
  echo "üñ•Ô∏è  Nodes:"
  kubectl get nodes 2>/dev/null || echo "  –ù–æ–¥—ã –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã"
  echo ""
  
  echo "üì¶ Pods –≤ namespace $K8S_NAMESPACE:"
  kubectl get pods -n "$K8S_NAMESPACE" 2>/dev/null || echo "  Namespace –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
  echo ""
  
  echo "üîó Services:"
  kubectl get svc -n "$K8S_NAMESPACE" 2>/dev/null || true
  echo ""
  
  echo "üöÄ Deployments:"
  kubectl get deployments -n "$K8S_NAMESPACE" 2>/dev/null || true
}

deploy_service() {
  local service=$1
  local environment=$2
  
  echo "üöÄ –î–µ–ø–ª–æ–π —Å–µ—Ä–≤–∏—Å–∞: $service"
  
  check_kubectl
  
  # –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ –µ—Å–ª–∏ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
  if [ "${SKIP_BUILD_ON_DEPLOY:-false}" != "true" ]; then
    build_service "$service" "$environment"
  fi
  
  # –°–æ–∑–¥–∞–µ–º namespace –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  kubectl create namespace "$K8S_NAMESPACE" 2>/dev/null || true
  
  # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–∞
  local manifests_dir="../../../../manifests"
  
  # Service
  if [ -f "$manifests_dir/02-services/${service}-service.yaml" ]; then
    echo "üì° –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Service –¥–ª—è $service"
    kubectl apply -f "$manifests_dir/02-services/${service}-service.yaml" -n "$K8S_NAMESPACE"
  else
    echo "‚ö†Ô∏è  Service –º–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: $manifests_dir/02-services/${service}-service.yaml"
  fi
  
  # Deployment
  if [ -f "$manifests_dir/03-deployments/${service}-deployment.yaml" ]; then
    echo "‚öôÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Deployment –¥–ª—è $service"
    
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è envsubst
    export SERVICE_NAME="$service"
    export ENVIRONMENT="$environment"
    export IMAGE_TAG="${CURRENT_IMAGE_TAG:-myapp-$service:latest}"
    export REPLICAS="${service^^}_REPLICAS"
    
    # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º
    envsubst < "$manifests_dir/03-deployments/${service}-deployment.yaml" | \
      kubectl apply -n "$K8S_NAMESPACE" -f -
  else
    echo "‚ö†Ô∏è  Deployment –º–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: $manifests_dir/03-deployments/${service}-deployment.yaml"
  fi
  
  echo "‚úÖ –°–µ—Ä–≤–∏—Å $service —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç"
  
  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
  kubectl get pods -n "$K8S_NAMESPACE" -l app="$service" 2>/dev/null || true
}

start_all_services() {
  local environment=$1
  
  echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
  
  for service in "${SERVICES[@]}"; do
    echo "  –ó–∞–ø—É—Å–∫ $service..."
    
    # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–æ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–ø–ª–∏–∫
    local replicas_var="${service^^}_REPLICAS"
    local replicas="${!replicas_var:-1}"
    
    kubectl scale deployment "$service" \
      --replicas="$replicas" \
      -n "$K8S_NAMESPACE" 2>/dev/null || \
    echo "  ‚ö†Ô∏è  Deployment $service –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π..."
    deploy_service "$service" "$environment"
  done
  
  echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã"
}

stop_all_services() {
  local environment=$1
  
  echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
  
  for service in "${SERVICES[@]}"; do
    echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ $service..."
    kubectl scale deployment "$service" \
      --replicas=0 \
      -n "$K8S_NAMESPACE" 2>/dev/null || true
  done
  
  echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

remove_service() {
  local service=$1
  local environment=$2
  
  echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞: $service"
  
  check_kubectl
  
  # –£–¥–∞–ª—è–µ–º deployment
  kubectl delete deployment "$service" -n "$K8S_NAMESPACE" --ignore-not-found=true
  
  # –£–¥–∞–ª—è–µ–º service
  kubectl delete service "$service" -n "$K8S_NAMESPACE" --ignore-not-found=true
  
  echo "‚úÖ –°–µ—Ä–≤–∏—Å $service —É–¥–∞–ª–µ–Ω"
}

destroy_cluster() {
  local environment=$1
  
  echo "üí• –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞..."
  
  case "$K8S_CLUSTER_TYPE" in
    "minikube")
      minikube delete
      ;;
    "kind")
      kind delete cluster --name "$KIND_CLUSTER_NAME"
      ;;
    "k3d")
      k3d cluster delete "$K3D_CLUSTER_NAME"
      ;;
    *)
      echo "‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫–ª–∞—Å—Ç–µ—Ä–∞: $K8S_CLUSTER_TYPE"
      echo "   –£–¥–∞–ª–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä –≤—Ä—É—á–Ω—É—é"
      ;;
  esac
  
  echo "‚úÖ –ö–ª–∞—Å—Ç–µ—Ä —É–¥–∞–ª–µ–Ω"
}

show_logs() {
  local service=$1
  local environment=$2
  
  check_kubectl
  
  echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞ $service:"
  kubectl logs -n "$K8S_NAMESPACE" deployment/"$service" --tail=50 -f
}

restart_service() {
  local service=$1
  local environment=$2
  
  echo "üîÅ –†–µ—Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞ $service"
  
  check_kubectl
  
  # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥—ã
  kubectl rollout restart deployment/"$service" -n "$K8S_NAMESPACE"
  
  # –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  kubectl rollout status deployment/"$service" -n "$K8S_NAMESPACE" --timeout=60s
  
  echo "‚úÖ –°–µ—Ä–≤–∏—Å $service –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
}

port_forward() {
  local service=$1
  local port_mapping=$2
  local environment=$3
  
  echo "üîå –ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ –¥–ª—è $service: $port_mapping"
  
  check_kubectl
  
  # –ó–∞–ø—É—Å–∫–∞–µ–º port-forward –≤ —Ñ–æ–Ω–µ
  kubectl port-forward -n "$K8S_NAMESPACE" deployment/"$service" "$port_mapping" &
  local pid=$!
  
  echo "‚úÖ Port-forward –∑–∞–ø—É—â–µ–Ω (PID: $pid)"
  echo "   –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: kill $pid"
}

setup_cluster() {
  local environment=$1
  
  echo "üèóÔ∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes..."
  
  case "$K8S_CLUSTER_TYPE" in
    "minikube")
      echo "  –ó–∞–ø—É—Å–∫ Minikube..."
      minikube start \
        --driver="${MINIKUBE_DRIVER:-docker}" \
        --cpus="${MINIKUBE_CPUS:-2}" \
        --memory="${MINIKUBE_MEMORY:-4096}" \
        --kubernetes-version="${K8S_VERSION:-v1.27.0}"
      
      # –í–∫–ª—é—á–µ–Ω–∏–µ –∞–¥–¥–æ–Ω–æ–≤
      minikube addons enable ingress
      minikube addons enable dashboard
      
      echo "‚úÖ Minikube –∫–ª–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω"
      ;;
      
    "kind")
      echo "  –°–æ–∑–¥–∞–Ω–∏–µ Kind –∫–ª–∞—Å—Ç–µ—Ä–∞..."
      if ! command -v kind &> /dev/null; then
        echo "‚ùå Kind –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        return 1
      fi
      
      kind create cluster \
        --name "${KIND_CLUSTER_NAME:-myapp-cluster}" \
        --config "${KIND_CONFIG_FILE:-kind-config.yaml}"
      
      echo "‚úÖ Kind –∫–ª–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω"
      ;;
      
    *)
      echo "‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫–ª–∞—Å—Ç–µ—Ä–∞: $K8S_CLUSTER_TYPE"
      echo "   –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞"
      ;;
  esac
  
  # –°–æ–∑–¥–∞–µ–º namespace
  kubectl create namespace "$K8S_NAMESPACE" 2>/dev/null || true
  
  echo "‚úÖ –ö–ª–∞—Å—Ç–µ—Ä –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
}